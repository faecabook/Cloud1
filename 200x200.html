<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Pro Image Editor 2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<style>
body {margin:0; font-family:'Segoe UI', sans-serif; background:#f0f2f5;}
header{padding:15px;text-align:center; background:#2563eb; color:white;}
.container{display:flex; flex-direction:column; gap:15px; padding:15px; max-width:1200px; margin:auto;}
.card{background:white; padding:15px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.1);}
canvas{border:1px solid #ccc; cursor:pointer; max-width:100%;}
.controls{display:flex; flex-wrap:wrap; gap:10px; margin-bottom:10px;}
button,input,select{margin:2px; padding:6px 10px; border-radius:6px; border:1px solid #ccc;}
button{background:#2563eb; color:white; border:none; cursor:pointer;}
button:hover{background:#1e40af;}
.panel{display:flex; flex-wrap:wrap; gap:10px; align-items:center;}
</style>
</head>
<body>
<header><h2>Pro Image Editor 2025</h2></header>
<div class="container">

<div class="card">
<canvas id="canvas" width="800" height="600"></canvas>
</div>

<div class="card panel">
<input type="file" id="uploadImage" accept="image/*" title="Upload รูป">
<input type="file" id="uploadSticker" accept="image/*" title="Upload Sticker">
<input type="text" id="imageURL" placeholder="วาง URL แล้ว Enter" title="นำเข้าจาก URL">
<button onclick="addText()">เพิ่มข้อความ</button>
<button onclick="deleteObject()">ลบวัตถุ</button>
<button onclick="undo()">Undo</button>
<button onclick="redo()">Redo</button>
<button onclick="downloadPNG()">ดาวน์โหลด PNG</button>
<button onclick="downloadGIF()">ดาวน์โหลด GIF</button>
</div>

<div class="card panel">
<label>ข้อความ:</label>
<input type="text" id="textInput" placeholder="แก้ข้อความ">
<label>Font:</label>
<select id="fontSelect">
<option>Arial</option><option>Verdana</option><option>Tahoma</option>
<option>Georgia</option><option>Courier New</option></select>
<label>Size:</label><input type="number" id="fontSize" value="30" style="width:60px">
<label>Color:</label><input type="color" id="fontColor" value="#ff0000">
<label>Stroke:</label><input type="color" id="strokeColor" value="#000000">
<label>Bold:</label><input type="checkbox" id="boldCheck">
<label>Italic:</label><input type="checkbox" id="italicCheck">
<label>Border Color:</label><input type="color" id="borderColor" value="#0000ff">
<label>Opacity:</label><input type="range" id="opacityRange" min="0" max="1" step="0.05" value="1">
</div>

<div class="card">
<h3>Preview 200x200</h3>
<canvas id="previewCanvas" width="200" height="200"></canvas>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<script>
const canvas = new fabric.Canvas('canvas', { preserveObjectStacking:true });
const preview = document.getElementById('previewCanvas');
const pctx = preview.getContext('2d');
let history=[], redoStack=[];

function saveHistory(){ history.push(JSON.stringify(canvas.toJSON())); if(history.length>50) history.shift(); redoStack=[]; }
function undo(){ if(history.length>0){ redoStack.push(JSON.stringify(canvas.toJSON())); canvas.loadFromJSON(history.pop(), canvas.renderAll.bind(canvas)); }}
function redo(){ if(redoStack.length>0){ history.push(JSON.stringify(canvas.toJSON())); canvas.loadFromJSON(redoStack.pop(), canvas.renderAll.bind(canvas)); }}

canvas.on('object:modified', saveHistory);
canvas.on('object:added', saveHistory);

function fitImage(img){
    const canvasWidth = canvas.getWidth();
    const canvasHeight = canvas.getHeight();
    const scale = Math.min(canvasWidth/img.width, canvasHeight/img.height);
    img.set({width:img.width*scale, height:img.height*scale, left:(canvasWidth - img.width*scale)/2, top:(canvasHeight - img.height*scale)/2});
}

document.getElementById('uploadImage').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f)return;
    const reader=new FileReader(); reader.onload=function(ev){
        fabric.Image.fromURL(ev.target.result, img=>{
            fitImage(img);
            canvas.add(img); saveHistory();
        }, {crossOrigin:'anonymous'});
    }; reader.readAsDataURL(f);
});

document.getElementById('uploadSticker').addEventListener('change', e=>{
    const f=e.target.files[0]; if(!f)return;
    const reader=new FileReader(); reader.onload=function(ev){
        fabric.Image.fromURL(ev.target.result, img=>{
            const scale = Math.min(200/img.width,200/img.height);
            img.set({width:img.width*scale, height:img.height*scale, left:100, top:100, stroke:'#00f', strokeWidth:2});
            canvas.add(img); saveHistory();
        }, {crossOrigin:'anonymous'});
    }; reader.readAsDataURL(f);
});

document.getElementById('imageURL').addEventListener('keydown', e=>{
    if(e.key==="Enter"){ const url=e.target.value.trim(); if(!url)return;
        fabric.Image.fromURL(url,img=>{
            fitImage(img);
            canvas.add(img); saveHistory(); drawPreview();
            e.target.value='';
        }, {crossOrigin:'anonymous'});
    }
});

function addText(){
    const t=prompt("ข้อความ:"); if(!t)return;
    const text=new fabric.Textbox(t,{
        left:50, top:50, fontSize:30, fill:'#f00', stroke:'#000', strokeWidth:1,
        fontFamily:'Arial', fontWeight:'normal', fontStyle:'normal', opacity:1
    });
    canvas.add(text); saveHistory();
}

function deleteObject(){ const active=canvas.getActiveObject(); if(active){ canvas.remove(active); saveHistory(); }}

document.getElementById('textInput').addEventListener('input', e=>{
    const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.text = e.target.value; canvas.renderAll(); saveHistory(); }
});
document.getElementById('fontSize').addEventListener('input', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.fontSize=parseInt(e.target.value); canvas.renderAll(); saveHistory(); }});
document.getElementById('fontColor').addEventListener('input', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.fill=e.target.value; canvas.renderAll(); saveHistory(); }});
document.getElementById('strokeColor').addEventListener('input', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.stroke=e.target.value; canvas.renderAll(); saveHistory(); }});
document.getElementById('fontSelect').addEventListener('change', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.fontFamily=e.target.value; canvas.renderAll(); saveHistory(); }});
document.getElementById('boldCheck').addEventListener('change', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.fontWeight=e.target.checked?'bold':'normal'; canvas.renderAll(); saveHistory(); }});
document.getElementById('italicCheck').addEventListener('change', e=>{ const obj = canvas.getActiveObject(); if(obj && obj.type==='textbox'){ obj.fontStyle=e.target.checked?'italic':'normal'; canvas.renderAll(); saveHistory(); }});
document.getElementById('borderColor').addEventListener('input', e=>{ const obj = canvas.getActiveObject(); if(obj){ obj.stroke=e.target.value; canvas.renderAll(); saveHistory(); }});
document.getElementById('opacityRange').addEventListener('input', e=>{ const obj = canvas.getActiveObject(); if(obj){ obj.opacity=parseFloat(e.target.value); canvas.renderAll(); saveHistory(); }});

function drawPreview(){
    pctx.clearRect(0,0,200,200);
    pctx.drawImage(canvas.lowerCanvasEl,0,0,200,200);
}
canvas.on('after:render', drawPreview);

function downloadPNG(){ const dataURL = canvas.toDataURL({format:'png'}); const a=document.createElement('a'); a.href=dataURL; a.download='edited.png'; a.click(); }

function downloadGIF(){
    const gif=new GIF({workers:2,quality:10});
    gif.addFrame(canvas.lowerCanvasEl,{copy:true,delay:500});
    gif.on('finished', b=>{ const a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='edited.gif'; a.click(); });
    gif.render();
}
</script>
</body>
</html>
