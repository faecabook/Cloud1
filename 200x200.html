<!doctype html>

    // เคลียร์ canvas
    function clearCanvas() {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      ctx.fillStyle = '#ffffff';
      ctx.fillRect(0,0,canvas.width,canvas.height);
    }
    clearCanvas();

    // อ่านไฟล์ภาพแล้วแสดงตัวอย่างใน canvas (ปรับเป็น 200x200 โดย crop กลาง)
    fileInput.addEventListener('change', async (e) => {
      downloadLink.style.display = 'none';
      toGifBtn.disabled = true;
      const file = e.target.files && e.target.files[0];
      if (!file) return;
      const url = URL.createObjectURL(file);
      const img = new Image();
      img.onload = () => {
        // คำนวณ crop เพื่อให้ภาพเต็ม 200x200 โดยรักษา aspect ratio
        const targetW = canvas.width;
        const targetH = canvas.height;
        const sw = img.width;
        const sh = img.height;

        // คำนวณ scale ให้เติมเต็ม (cover)
        const scale = Math.max(targetW / sw, targetH / sh);
        const drawW = sw * scale;
        const drawH = sh * scale;
        // ตำแหน่งเริ่มต้นเพื่อ crop กลาง
        const dx = (targetW - drawW) / 2;
        const dy = (targetH - drawH) / 2;

        // วาดพื้นขาวก่อน (ป้องกันภาพใสหาย)
        clearCanvas();
        ctx.drawImage(img, dx, dy, drawW, drawH);
        toGifBtn.disabled = false;
        URL.revokeObjectURL(url);
      };
      img.onerror = () => {
        alert('ไม่สามารถโหลดภาพได้');
        URL.revokeObjectURL(url);
      };
      img.src = url;
    });

    // สร้าง GIF จาก canvas (1 เฟรม) แล้วให้ดาวน์โหลด
    toGifBtn.addEventListener('click', () => {
      toGifBtn.disabled = true;
      downloadLink.style.display = 'none';
      const outName = (filenameInput.value || 'output').replace(/[^a-zA-Z0-9-_]/g, '_') + '.gif';

      // ตรวจสอบว่ามี gif.js
      if (typeof GIF === 'undefined') {
        alert('ไม่พบไลบรารี GIF (gif.js) — ต้องออนไลน์เพื่อโหลดจาก CDN');
        toGifBtn.disabled = false;
        return;
      }

      const gif = new GIF({
        workers: 2,
        quality: 10,
        workerScript: 'https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.worker.js'
      });

      // เพิ่มเฟรมจาก canvas (copy canvas เพื่อแน่ใจว่าได้ภาพที่ชัด)
      // frame delay 500ms (ปรับได้)
      gif.addFrame(canvas, {copy: true, delay: 500});

      gif.on('finished', function(blob) {
        const url = URL.createObjectURL(blob);
        downloadLink.href = url;
        downloadLink.download = outName;
        downloadLink.style.display = 'inline-block';
        downloadLink.textContent = 'ดาวน์โหลด ' + outName;
        toGifBtn.disabled = false;
      });

      gif.on('progress', function(p) {
        toGifBtn.textContent = 'กำลังสร้าง GIF ' + Math.round(p * 100) + '%';
      });

      gif.render();
    });
  </script>
</body>
</html>
