<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Modern Image Editor + GIF Export</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin:0; padding:0;
        background:#f0f2f5;
        display:flex; flex-direction:column; align-items:center;
    }
    h2 {color:#333; text-align:center;}
    .container {
        display:flex; gap:20px; flex-wrap:wrap; max-width:1200px; margin:20px;
    }
    .editor, .preview {
        background:#fff; padding:15px; border-radius:12px;
        box-shadow:0 4px 12px rgba(0,0,0,0.1);
    }
    canvas {border:1px solid #ccc; cursor:pointer; background:#fafafa;}
    button {
        background:#2563eb; color:white; border:none; padding:8px 14px;
        border-radius:8px; cursor:pointer; margin:2px;
    }
    button:hover {background:#1e40af;}
    input[type=file]{margin:5px 0;}
    #previewBox {width:200px; height:200px; overflow:hidden; border:2px solid #000;}
</style>
</head>
<body>

<h2>Modern Image Editor (PNG / GIF Export)</h2>

<div class="container">
    <div class="editor">
        <h3>Editor</h3>
        <input type="file" id="uploadBackground" accept="image/*"><br>
        <input type="file" id="uploadDecoration" accept="image/*"><br>
        <button onclick="addText()">เพิ่มข้อความ</button>
        <button onclick="downloadPNG()">ดาวน์โหลด PNG</button>
        <button onclick="downloadGIF()">ดาวน์โหลด GIF</button>
        <br><br>
        <canvas id="mainCanvas" width="500" height="500"></canvas>
    </div>

    <div class="preview">
        <h3>Preview 200x200</h3>
        <div id="previewBox">
            <canvas id="previewCanvas" width="200" height="200"></canvas>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<script>
let canvas = document.getElementById("mainCanvas");
let ctx = canvas.getContext("2d");
let previewCanvas = document.getElementById("previewCanvas");
let pctx = previewCanvas.getContext("2d");

let objects = [];
let selected = null;
let dragOffsetX=0, dragOffsetY=0;
let resizing=false;

// โหลด Background
document.getElementById("uploadBackground").addEventListener("change", e=>{
    let file = e.target.files[0]; if(!file) return;
    let reader = new FileReader();
    reader.onload=function(evt){
        let img=new Image(); img.onload=function(){
            objects[0]={type:"image", img:img, x:0,y:0,w:canvas.width,h:canvas.height};
            draw();
        }; img.src=evt.target.result;
    };
    reader.readAsDataURL(file);
});

// โหลด Decoration
document.getElementById("uploadDecoration").addEventListener("change", e=>{
    let file = e.target.files[0]; if(!file) return;
    let reader = new FileReader();
    reader.onload=function(evt){
        let img=new Image(); img.onload=function(){
            objects.push({type:"image", img:img, x:50,y:50,w:100,h:100});
            draw();
        }; img.src=evt.target.result;
    };
    reader.readAsDataURL(file);
});

// เพิ่มข้อความ
function addText(){
    let text=prompt("พิมพ์ข้อความ:"); if(!text) return;
    objects.push({type:"text", text:text, x:50,y:50, size:30, color:"red"});
    draw();
}

// วาดทุก layer + preview
function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let obj of objects){
        if(obj.type==="image") ctx.drawImage(obj.img,obj.x,obj.y,obj.w,obj.h);
        else if(obj.type==="text"){ ctx.font=obj.size+"px Arial"; ctx.fillStyle=obj.color; ctx.fillText(obj.text,obj.x,obj.y);}
    }
    drawHandles();
    updatePreview();
}

// พรีวิว 200x200
function updatePreview(){
    pctx.clearRect(0,0,200,200);
    pctx.drawImage(canvas,0,0,200,200);
}

// ดาวน์โหลด PNG
function downloadPNG(){
    let link=document.createElement("a");
    link.download="edited.png";
    link.href=canvas.toDataURL();
    link.click();
}

// ดาวน์โหลด GIF (single frame)
function downloadGIF(){
    let gif = new GIF({ workers:2, quality:10 });
    gif.addFrame(canvas,{copy:true, delay:200});
    gif.on('finished', function(blob){
        let link=document.createElement("a");
        link.href=URL.createObjectURL(blob);
        link.download="edited.gif";
        link.click();
    });
    gif.render();
}

// เลือกและลาก/ย่อขยาย
canvas.addEventListener("mousedown", e=>{
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left;
    const my=e.clientY-rect.top;
    for(let i=objects.length-1;i>=0;i--){
        let o=objects[i];
        if(o.type==="image" && mx>=o.x && mx<=o.x+o.w && my>=o.y && my<=o.y+o.h){
            selected=o; dragOffsetX=mx-o.x; dragOffsetY=my-o.y;
            if(Math.abs(mx-(o.x+o.w))<10 && Math.abs(my-(o.y+o.h))<10) resizing=true;
            return;
        }
        else if(o.type==="text"){
            ctx.font=o.size+"px Arial";
            let w=ctx.measureText(o.text).width; let h=o.size;
            if(mx>=o.x && mx<=o.x+w && my<=o.y && my>=o.y-h){
                selected=o; dragOffsetX=mx-o.x; dragOffsetY=my-o.y;
                if(Math.abs(mx-(o.x+w))<10 && Math.abs(my-(o.y))<10) resizing=true;
                return;
            }
        }
    }
    selected=null;
    draw();
});

canvas.addEventListener("mousemove", e=>{
    if(!selected) return;
    const rect=canvas.getBoundingClientRect();
    const mx=e.clientX-rect.left;
    const my=e.clientY-rect.top;
    if(resizing){
        if(selected.type==="image"){ selected.w=Math.max(10,mx-selected.x); selected.h=Math.max(10,my-selected.y);}
        else if(selected.type==="text"){ selected.size=Math.max(10,my-selected.y);}
    }else{
        selected.x=mx-dragOffsetX; selected.y=my-dragOffsetY;
    }
    draw();
});

canvas.addEventListener("mouseup", e=>{ selected=null; resizing=false;});
canvas.addEventListener("mouseleave", e=>{ selected=null; resizing=false;});

// วาด handle มุมล่างขวา
function drawHandles(){
    if(!selected) return;
    ctx.save();
    ctx.strokeStyle="blue"; ctx.lineWidth=2;
    if(selected.type==="image"){
        ctx.strokeRect(selected.x,selected.y,selected.w,selected.h);
        ctx.fillStyle="blue"; ctx.fillRect(selected.x+selected.w-5,selected.y+selected.h-5,10,10);
    }else if(selected.type==="text"){
        ctx.strokeRect(selected.x,selected.y-selected.size,ctx.measureText(selected.text).width,selected.size);
        ctx.fillStyle="blue"; ctx.fillRect(selected.x+ctx.measureText(selected.text).width-5,selected.y-5,10,10);
    }
    ctx.restore();
}
</script>

</body>
</html>
