<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Advanced Image Editor 2025</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body {font-family:'Segoe UI', sans-serif; background:#f2f4f7; margin:0; padding:20px; display:flex; flex-direction:column; align-items:center;}
h2 {text-align:center; color:#333;}
.container {display:flex; flex-wrap:wrap; gap:20px; max-width:1200px;}
.card {background:#fff; padding:15px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
canvas {border:1px solid #ccc; cursor:pointer; background:#fafafa;}
button {background:#2563eb; color:white; border:none; padding:8px 14px; border-radius:8px; margin:2px; cursor:pointer;}
button:hover {background:#1e40af;}
#previewBox {width:200px; height:200px; border:2px solid #000; overflow:hidden;}
.input-group {margin:5px 0;}
.handle {width:10px; height:10px; background:blue; position:absolute; cursor:pointer;}
</style>
</head>
<body>

<h2>Advanced Image Editor 2025</h2>
<div class="container">

<div class="card" style="position:relative;">
<h3>Editor</h3>
<div class="input-group">
<input type="file" id="uploadBackground" accept="image/*">
</div>
<div class="input-group">
<input type="file" id="uploadDecoration" accept="image/*">
</div>
<div class="input-group">
<input type="text" id="imageURL" placeholder="วาง URL ภาพแล้ว Enter">
</div>
<div class="input-group">
<input type="color" id="borderColor" value="#ff0000"> เลือกสีกรอบสำหรับภาพใหม่
</div>
<button onclick="addText()">เพิ่มข้อความ</button>
<button onclick="downloadPNG()">ดาวน์โหลด PNG</button>
<button onclick="downloadGIF()">ดาวน์โหลด GIF</button>

<canvas id="mainCanvas" width="600" height="500"></canvas>
</div>

<div class="card">
<h3>Preview 200x200</h3>
<div id="previewBox">
<canvas id="previewCanvas" width="200" height="200"></canvas>
</div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/gif.js/0.2.0/gif.js"></script>
<script>
const canvas=document.getElementById("mainCanvas"), ctx=canvas.getContext("2d");
const previewCanvas=document.getElementById("previewCanvas"), pctx=previewCanvas.getContext("2d");

let objects=[], selected=null, dragOffsetX=0, dragOffsetY=0;
let resizing=false, resizeCorner=null, rotating=false, rotateStartAngle=0;

const borderColorInput = document.getElementById("borderColor");

function draw(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    for(let obj of objects){
        ctx.save();
        ctx.translate(obj.x+obj.w/2,obj.y+obj.h/2);
        ctx.rotate((obj.angle||0)*Math.PI/180);
        ctx.translate(-(obj.x+obj.w/2),-(obj.y+obj.h/2));
        if(obj.type==="image") ctx.drawImage(obj.img,obj.x,obj.y,obj.w,obj.h);
        else if(obj.type==="text"){ ctx.font=obj.size+"px Arial"; ctx.fillStyle=obj.color; ctx.fillText(obj.text,obj.x,obj.y);}
        if(obj.border){
            ctx.strokeStyle=obj.border;
            ctx.lineWidth=3;
            ctx.strokeRect(obj.x,obj.y,obj.w,obj.h);
        }
        ctx.restore();
    }
    drawHandles();
    updatePreview();
}

function updatePreview(){
    pctx.clearRect(0,0,200,200);
    pctx.drawImage(canvas,0,0,200,200);
}

function downloadPNG(){
    const link=document.createElement("a");
    link.download="edited.png";
    link.href=canvas.toDataURL();
    link.click();
}

function downloadGIF(){
    const gif = new GIF({workers:2, quality:10});
    gif.addFrame(canvas,{copy:true, delay:200});
    gif.on('finished', blob=>{
        const link=document.createElement("a");
        link.href=URL.createObjectURL(blob);
        link.download="edited.gif";
        link.click();
    });
    gif.render();
}

// โหลด Background
document.getElementById("uploadBackground").addEventListener("change", e=>{
    let file=e.target.files[0]; if(!file) return;
    let reader=new FileReader();
    reader.onload=function(evt){
        let img=new Image(); img.onload=function(){
            objects[0]={type:"image", img:img, x:0,y:0,w:canvas.width,h:canvas.height, angle:0};
            draw();
        }; img.src=evt.target.result;
    }; reader.readAsDataURL(file);
});

// โหลด Decoration
document.getElementById("uploadDecoration").addEventListener("change", e=>{
    let file=e.target.files[0]; if(!file) return;
    let reader=new FileReader();
    reader.onload=function(evt){
        let img=new Image(); img.onload=function(){
            objects.push({type:"image", img:img, x:50,y:50,w:100,h:100, angle:0, border:borderColorInput.value});
            draw();
        }; img.src=evt.target.result;
    }; reader.readAsDataURL(file);
});

// URL
document.getElementById("imageURL").addEventListener("keydown", e=>{
    if(e.key==="Enter"){
        let url = e.target.value.trim(); if(!url) return;
        let img=new Image(); img.crossOrigin="anonymous";
