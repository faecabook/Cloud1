<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Image Editor Pro + 200x200 Preview</title>
<style>
    body {
        font-family: sans-serif;
        display: flex;
        gap: 20px;
    }
    #editorArea {
        border: 1px solid #ccc;
        position: relative;
        cursor: grab;
    }
    canvas {
        background: #f0f0f0;
    }
    #previewBox {
        border: 2px solid #000;
        width: 200px;
        height: 200px;
        overflow: hidden;
    }
    #previewCanvas {
        width: 200px;
        height: 200px;
    }
</style>
</head>
<body>

<div>
    <h3>เครื่องมือแก้ไขรูป</h3>

    <input type="file" id="uploadImage" accept="image/*"><br><br>

    <button onclick="addText()">เพิ่มข้อความ</button>
    <button onclick="downloadImage()">ดาวน์โหลด PNG</button>

    <br><br>

    <div id="editorArea">
        <canvas id="mainCanvas" width="500" height="500"></canvas>
    </div>
</div>

<div>
    <h3>พรีวิว 200×200</h3>
    <div id="previewBox">
        <canvas id="previewCanvas" width="200" height="200"></canvas>
    </div>
</div>

<script>
let canvas = document.getElementById("mainCanvas");
let ctx = canvas.getContext("2d");

let previewCanvas = document.getElementById("previewCanvas");
let pctx = previewCanvas.getContext("2d");

// -----------------------
// วัตถุทั้งหมด: รูป + ข้อความ
// -----------------------
let objects = [];

let activeObject = null;
let dragging = false;
let resizing = false;

// อัปโหลดรูป
document.getElementById("uploadImage").addEventListener("change", function (e) {
    let file = e.target.files[0];
    if (!file) return;

    let reader = new FileReader();
    reader.onload = function (evt) {
        let img = new Image();
        img.onload = function () {
            objects.push({
                type: "image",
                img: img,
                x: 50,
                y: 50,
                w: img.width / 2,
                h: img.height / 2
            });
            drawAll();
        };
        img.src = evt.target.result;
    };
    reader.readAsDataURL(file);
});

// เพิ่มข้อความ
function addText() {
    objects.push({
        type: "text",
        text: "ข้อความ",
        x: 100,
        y: 100,
        w: 150,
        h: 50,
        fontSize: 40,
        color: "red"
    });
    drawAll();
}

// ตรวจว่าคลิกโดน object ไหน
function getObjectAt(x, y) {
    for (let i = objects.length - 1; i >= 0; i--) {
        let o = objects[i];
        if (
            x >= o.x && x <= o.x + o.w &&
            y >= o.y && y <= o.y + o.h
        ) {
            return o;
        }
    }
    return null;
}

// เมื่อคลิกเมาส์
canvas.addEventListener("mousedown", function (e) {
    let rect = canvas.getBoundingClientRect();
    let x = e.clientX - rect.left;
    let y = e
